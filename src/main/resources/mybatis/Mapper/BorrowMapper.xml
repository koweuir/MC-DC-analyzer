<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ctc.library.dao.BorrowDao">
    <insert id="insertBorrow" useGeneratedKeys="true" keyProperty="borrowId">
        INSERT INTO borrow
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="bookId != null">bookId,</if>
            <if test="unitName != null">unitName,</if>
            <if test="userName != null">userName,</if>
            <if test="borrowTime != null">borrowTime,</if>
            <if test="returnTime != null">returnTime,</if>
            <if test="reason != null">reason,</if>
            <if test="phone != null">phone,</if>
            <if test="borrowStatus != null">borrowStatus,</if>
            <if test="comment != null">comment,</if>
        </trim>
        VALUES
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="bookId != null">#{bookId},</if>
            <if test="unitName != null">#{unitName},</if>
            <if test="userName != null">#{userName},</if>
            <if test="borrowTime != null">#{borrowTime},</if>
            <if test="returnTime != null">#{returnTime},</if>
            <if test="reason != null">#{reason},</if>
            <if test="phone != null">#{phone},</if>
            <if test="borrowStatus != null">#{borrowStatus},</if>
            <if test="comment != null">#{comment},</if>
        </trim>
    </insert>
    <update id="updateAll">
        UPDATE borrow
        <set>
            <if test="bookId != null">
                bookId = #{bookId},
            </if>
            <if test="unitName != null">
                unitName = #{unitName},
            </if>
            <if test="userName != null">
                userName = #{userName},
            </if>
            <if test="borrowTime != null">
                borrowTime = #{borrowTime},
            </if>
            <if test="returnTime != null">
                returnTime = #{returnTime},
            </if>
            <if test="reason != null">
                reason = #{reason},
            </if>
            <if test="phone != null">
                phone = #{phone},
            </if>
            <if test="borrowStatus != null">
                borrowStatus = #{borrowStatus},
            </if>
            <if test="comment != null">
                comment = #{comment},
            </if>
        </set>
        WHERE borrowId = #{borrowId}
    </update>
    <select id="selectBorrowByNo" resultType="com.ctc.library.entity.Borrow">
        select * FROM borrow where borrowId = #{borrowId}
    </select>
    <select id="selectAllBorrowsIn" resultType="com.ctc.library.entity.Borrow">
        SELECT * FROM borrow where userName = #{userName}
                             and borrowStatus = #{borrowStatus}
        LIMIT #{pageNum}, #{pageSize}
    </select>
    <select id="selectTotalIn" resultType="java.lang.Integer">
        select count(*) from borrow where userName = #{userName}
                                    and borrowStatus = #{borrowStatus}
    </select>
    <select id="selectAllBorrowsOut" resultType="com.ctc.library.entity.Borrow">
        SELECT * FROM borrow where unitName = #{unitName}
                             and borrowStatus = #{borrowStatus}
        LIMIT #{pageNum}, #{pageSize}
    </select>
    <select id="selectTotalOut" resultType="java.lang.Integer">
        select count(*) from borrow where unitName = #{unitName}
                                    and borrowStatus = #{borrowStatus}
    </select>
    <select id="getBorrowCountByMonth" resultType="java.util.Map">
        SELECT DATE_FORMAT(borrowTime, '%Y-%m') AS month, COUNT(*) AS count
        FROM borrow
        WHERE unitName = #{unitName} AND borrowTime IS NOT NULL
        GROUP BY DATE_FORMAT(borrowTime, '%Y-%m')
        ORDER BY DATE_FORMAT(borrowTime, '%Y-%m')
    </select>
</mapper>